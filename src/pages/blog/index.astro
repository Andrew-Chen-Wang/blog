---
import Layout from "@layouts/Layout.astro";
import BlogHeader from "@components/blog/BlogHeader.astro";
import TagFilter from "@components/TagFilter.astro";
import Tag from "@components/Tag.astro";
import { DEFAULT_LOCALE } from "@src/consts";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { getLocale, getLocaleUrlPrefix } from "astro-i18n-aut";
import Container from "@src/components/Container.astro";
import HeroImage from "@src/components/blog/HeroImage.astro";

const locale = getLocale(Astro.url) ?? DEFAULT_LOCALE;
const localeUrlPrefix = getLocaleUrlPrefix(Astro.url);

const posts = (await getCollection("blog", (entry) => entry.id.startsWith(`${locale}/`)))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.map<CollectionEntry<"blog"> & { href: string }>((post) => {
		return {
			href: localeUrlPrefix + "/blog" + post.id.replace(locale, "") + "/",
			...post,
		};
	});

const tagCounts = posts.reduce((acc, post) => {
	(post.data.tags ?? []).forEach((tag) => {
		acc[tag] = (acc[tag] || 0) + 1;
	});
	return acc;
}, {} as Record<string, number>);
---

<Layout title="Blog">
	<Container class="pt-16">
		{Object.keys(tagCounts).length > 0 && (
			<TagFilter tagCounts={tagCounts} totalCount={posts.length} class="mb-8" />
		)}
		<ul
			class="m-0 list-none space-y-6 p-0"
			x-data="{ selectedTag: null }"
			@tag-filter.window="selectedTag = $event.detail.tag"
		>
			{
				posts.map((post: any) => {
					const postTags = post.data.tags ?? [];
					const tagsJson = JSON.stringify(postTags);
					return (
						<li
							x-show={`selectedTag === null || ${tagsJson}.includes(selectedTag)`}
							x-transition:enter="transition ease-out duration-200"
							x-transition:enter-start="opacity-0"
							x-transition:enter-end="opacity-100"
						>
							<a href={post.href} class="block transition-colors duration-200">
								{post.data.heroImage && (
									<HeroImage
										class="mb-2 rounded-lg hover:shadow-md"
										src={post.data.heroImage}
										alt={post.data.title}
										width={720}
										height={360}
									/>
								)}
								<BlogHeader
									pubDate={post.data.pubDate}
									name={`title-${post.data.title}`}
									isSubheading={true}
									class="m-0">
									{post.data.title}
								</BlogHeader>
							</a>
							{postTags.length > 0 && (
								<div class="mt-2 flex flex-wrap gap-1">
									{postTags.map((tag: string) => (
										<Tag tag={tag} class="text-xs" />
									))}
								</div>
							)}
						</li>
					);
				})
			}
		</ul>
	</Container>
</Layout>
