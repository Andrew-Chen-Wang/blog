---
import Layout from "@layouts/Layout.astro";
import BlogHeader from "@components/blog/BlogHeader.astro";
import TagFilter from "@components/TagFilter.astro";
import Tag from "@components/Tag.astro";
import { DEFAULT_LOCALE } from "@src/consts";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { getLocale, getLocaleUrlPrefix } from "astro-i18n-aut";
import Container from "@src/components/Container.astro";
import HeroImage from "@src/components/blog/HeroImage.astro";

const locale = getLocale(Astro.url) ?? DEFAULT_LOCALE;
const localeUrlPrefix = getLocaleUrlPrefix(Astro.url);

const thoughts = (await getCollection("shortthoughts", (entry) => entry.id.startsWith(`${locale}/`)))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.map<CollectionEntry<"shortthoughts"> & { href: string }>((thought) => {
		return {
			href: localeUrlPrefix + "/short-thoughts" + thought.id.replace(locale, "") + "/",
			...thought,
		};
	});

const tagCounts = thoughts.reduce((acc, thought) => {
	(thought.data.tags ?? []).forEach((tag) => {
		acc[tag] = (acc[tag] || 0) + 1;
	});
	return acc;
}, {} as Record<string, number>);
---

<Layout title="Short Thoughts">
	<Container class="pt-16">
		{Object.keys(tagCounts).length > 0 && (
			<TagFilter tagCounts={tagCounts} totalCount={thoughts.length} class="mb-8" />
		)}
		<ul
			class="m-0 list-none space-y-6 p-0"
			x-data="{ selectedTag: null }"
			@tag-filter.window="selectedTag = $event.detail.tag"
		>
			{
				thoughts.map((thought: any) => {
					const thoughtTags = thought.data.tags ?? [];
					const tagsJson = JSON.stringify(thoughtTags);
					return (
						<li
							x-show={`selectedTag === null || ${tagsJson}.includes(selectedTag)`}
							x-transition:enter="transition ease-out duration-200"
							x-transition:enter-start="opacity-0"
							x-transition:enter-end="opacity-100"
						>
							<a href={thought.href} class="block transition-colors duration-200">
								{thought.data.heroImage && (
									<HeroImage
										class="mb-2 rounded-lg hover:shadow-md"
										src={thought.data.heroImage}
										alt={thought.data.title}
										width={720}
										height={360}
									/>
								)}
								<BlogHeader
									pubDate={thought.data.pubDate}
									name={`title-${thought.data.title}`}
									isSubheading={true}
									class="m-0">
									{thought.data.title}
								</BlogHeader>
							</a>
							{thoughtTags.length > 0 && (
								<div class="mt-2 flex flex-wrap gap-1">
									{thoughtTags.map((tag: string) => (
										<Tag tag={tag} class="text-xs" />
									))}
								</div>
							)}
						</li>
					);
				})
			}
		</ul>
	</Container>
</Layout>
